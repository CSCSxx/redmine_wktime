<% wktime_helper = Object.new.extend(WktimeHelper) %>
<% base_helper = Object.new.extend(WkbaseHelper) %>
<% 
   lastAttnEntries = wktime_helper.findLastAttnEntry(true)
   if !lastAttnEntries.blank? 
  	  @lastAttnEntry = lastAttnEntries[0]
   end 
   lastTimeEntries = WkSpentFor.lastEntry
   if !lastTimeEntries.blank? 
  	  @lastTimeEntry = lastTimeEntries[0]
   end   
%>
<style>
#clockINOUT {
	float: right; 
	display: flex; 
	flex-direction: row-reverse; 
	cursor: pointer; 
	margin-left: 10px;
}
#appendlabel{
    padding-top: 5px;
    padding-left: 4px;
	font-size: 13px;
}
#startdiv, #enddiv{
	float: right;
}
#issueLog {
	cursor: pointer;
	margin-left: 10px;
}
#issueTime, #issueTracker{
	padding-left: 4px;
}
</style>
<% if (!Setting.plugin_redmine_wktime['wktime_enable_clock_in_out'].blank? &&
		Setting.plugin_redmine_wktime['wktime_enable_clock_in_out'].to_i == 1) && (!Setting.plugin_redmine_wktime['wktime_enable_attendance_module'].blank? && Setting.plugin_redmine_wktime['wktime_enable_attendance_module'].to_i == 1 ) %>	
	<%	if !@lastAttnEntry.blank?
			if(@lastAttnEntry.end_time.blank? && @lastAttnEntry.start_time > 24.hour.ago)
				hideStart = true
				hideEnd = false
				imglabel = "end"
				remaininghr =  (wktime_helper.computeWorkedHours(@lastAttnEntry.start_time, Time.now.localtime, false))
			else
				hideStart = false
				hideEnd = true
			end
			imglabel = (@lastAttnEntry.end_time.blank? && @lastAttnEntry.start_time > 24.hour.ago ? "end" : "start")
		else
			hideStart = false
			hideEnd = true
		end
		 
		imgname = "#{imglabel}" == "start" ? "clockin1.jpg" : "clockout1.jpg" %>	
	<% totalhours = (wktime_helper.totalhours)*3600 %>
	<% totalhours = (hideStart ? ( !remaininghr.blank? ? remaininghr.round(0)+totalhours : totalhours) : totalhours ) %>
	<% totalhours1 = Time.at(totalhours).utc.strftime("%H:%M") %>
	<% host_with_subdir = wktime_helper.getHostAndDir(request) %>
	<%=h hidden_field_tag('clockinout_url',  "#{url_for(:controller => 'wkbase', :action => 'updateClockInOut', :host => host_with_subdir, :only_path => true)}" )  %>
	<% if User.current.logged? && wktime_helper.checkViewPermission %>
	<div style="clear: both;"></div>	
	<div id="clockINOUT">
		<span id="appendlabel"><%= totalhours1 %></span>
		<div id="startdiv">
			<%= image_tag("widgetclockin.png", :id => 'clockin' , :plugin => "redmine_wktime", :style => hideStart ? "display:none;" : "display:block;" ) %>		
		</div>
		<div id="enddiv">
			<%= image_tag("widgetclockout.png", :id => 'clockout', :plugin => "redmine_wktime", :style => hideEnd ? "display:none;" : "display:block;") %>		
		</div>
	</div>
<% end %>	
<% if (!Setting.plugin_redmine_wktime['label_enable_issue_logger'].blank? &&
	Setting.plugin_redmine_wktime['label_enable_issue_logger'].to_i == 1) %>
		<%	if !@lastTimeEntry.blank?
					tracker = Tracker.joins(" Left join issues ON issues.tracker_id = trackers.id").where('issues.id=?', @lastTimeEntry.issue_id).first
					trackerName =  tracker.name + '#' + @lastTimeEntry.issue_id.to_s
					if(@lastTimeEntry.end_on.blank? && @lastTimeEntry.start_on > 24.hour.ago)
						remainingTimehr =  (wktime_helper.computeWorkedHours(@lastTimeEntry.start_on, Time.now.localtime, false))
					end
				end
		%>
		<% totalhours = 0.0 %>
		<% totalhours = remainingTimehr.round(0) if !remainingTimehr.blank? %>
		<% totalhours1 = Time.at(totalhours).utc.strftime("%H:%M") %>	
		<% imgName = remainingTimehr.blank? ? "start.png" : "finish.png" %>	
		<% if User.current.logged? && wktime_helper.checkViewPermission %>
			<%= issue = Issue.select(:id, :subject)
					text = image_tag(imgName, plugin: "redmine_wktime")
					trigger = content_tag('span', text, class: 'drdn-trigger')
					url = '/wkbase/autocomplete.js'
					q = text_field_tag('q', '', id: 'issues-quick-search', class: 'autocomplete', data: {automcomplete_url: url},
														autocomplete: 'off')
					content = content_tag('div', content_tag('div', q, class: 'quick-search') +
												content_tag('div', base_helper.getIssueList(issue), class: 'drdn-items issues selection'),
												class: 'drdn-content' )
					content_tag('div', trigger + content, id: "issueLog", class: "drdn") 
			 %>
			<span id="issueTracker"><%= trackerName %></span>
			<span id="issueTime"><%= totalhours1 %></span>
		<% end %>
		<div style="clear: both;"></div>
	<% end %>
	<% end %>	